databases:
  - name: db
    postgresMajorVersion: 15

services:
  - type: web
    name: app
    runtime: python
    startCommand: python3 app.py
    healthCheckPath: /health
    envVars:
      - key: APP_ENV
        value: development
      - key: APP_HOST
        value: 0.0.0.0
      - key: APP_PORT
        value: 5000
      - key: JWT_SECRET_KEY
        value: 1a9b535f2a8c98284bbfeb9a28cff8ffbf883e41ab7c6cc0bd5444d5bdf2adc0
      - key: PG_ROOT_PASS
        fromDatabase:
          name: db
          property: connectionString
      - key: PG_USER
        fromDatabase:
          type: database
          name: db
          property: connectionString
      - key: PG_PWD
        fromDatabase:
          type: database
          name: db
          property: connectionString
      - key: PG_DB
        fromDatabase:
          type: database
          name: db
          property: connectionString
      - key: PG_HOST
        fromDatabase:
          type: database
          name: db
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: celery-redis
          property: connectionString
        ipAllowList:
          - source: 127.0.0.1:5173
    disk:
      name: escrowapp
      mountPath: /app

  - type: worker
    name: queue
    env: python
    startCommand: "celery -A app.celery worker --loglevel=info"
    autoDeploy: True
    envVars:
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: celery-redis
          property: connectionString

  - type: web
    name: flower
    plan: free
    env: python
    startCommand: "celery flower app.celery --loglevel=info"
    autoDeploy: false
    envVars:
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: celery-redis
          property: connectionString

  - type: redis
    name: celery-redis
    plan: starter
    maxmemoryPolicy: noeviction # recommended policy for queues
    ipAllowList: []
